<template>
  <div class="login">
    <svg
      width="109px"
      height="49px"
      viewBox="0 0 109 49"
      version="1.1"
      xmlns="http://www.w3.org/2000/svg"
      xmlns:xlink="http://www.w3.org/1999/xlink"
    >
      <desc>Created with Sketch.</desc>
      <defs></defs>
      <g id="Random" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="SendyLogo_120by60px-01" fill-rule="nonzero">
          <path
            d="M50.2314815,30.9814815 C51.3257225,31.6380617 52.5757814,31.9897406 53.8518519,32 C55.9166667,32 57.1203704,30.9074074 57.1203704,29.3333333 C57.1203704,27.7592593 56.287037,27.037037 54.1759259,26.2222222 C51.6296296,25.2962963 50.0462963,24 50.0462963,21.7962963 C50.0462963,19.3611111 52.0648148,17.5555556 55.1018519,17.5555556 C56.2994483,17.5166612 57.4874551,17.7810166 58.5555556,18.3240741 L58,19.9722222 C57.0863224,19.4818584 56.0647182,19.227253 55.0277778,19.2314815 C52.8981481,19.2314815 52.0833333,20.5092593 52.0833333,21.5740741 C52.0833333,23.037037 53.0092593,23.75 55.1944444,24.5833333 C57.8333333,25.6018519 59.1851852,26.8796296 59.1851852,29.212963 C59.1851852,31.5462963 57.4074074,33.6759259 53.7037037,33.6759259 C52.3094738,33.692361 50.9346989,33.3478698 49.712963,32.6759259 L50.2314815,30.9814815 Z"
            id="Shape"
            fill="#1E7FC3"
          ></path>
          <path
            d="M69.1296296,26.7407407 C69.1296296,25.4351852 68.5925926,23.4259259 66.3055556,23.4259259 C64.2407407,23.4259259 63.3333333,25.3240741 63.1759259,26.7407407 L69.1296296,26.7407407 Z M63.1481481,28.2037037 C63.0553257,29.2550532 63.4295071,30.2940338 64.1713438,31.0447868 C64.9131805,31.7955398 65.9476166,32.1821072 67,32.1018519 C68.0665584,32.12082 69.1246318,31.9092053 70.1018519,31.4814815 L70.4444444,32.9444444 C69.271679,33.4312248 68.0101897,33.6677541 66.7407407,33.6388889 C63.287037,33.6388889 61.1851852,31.3703704 61.1851852,27.9814815 C61.1851852,24.5925926 63.1759259,21.9259259 66.4444444,21.9259259 C70.1481481,21.9259259 71.0740741,25.1481481 71.0740741,27.212963 C71.0677201,27.5227985 71.0429853,27.8319839 71,28.1388889 L63.1481481,28.2037037 Z"
            id="Shape"
            fill="#1E7FC3"
          ></path>
          <path
            d="M73.6296296,25.2592593 C73.6296296,24.1018519 73.6296296,23.1481481 73.537037,22.2222222 L75.3888889,22.2222222 L75.5,24.0740741 L75.5462963,24.0740741 C76.2941267,22.7382703 77.7195625,21.9257719 79.25,21.962963 C80.8055556,21.962963 83.212963,22.8888889 83.212963,26.7407407 L83.212963,33.4444444 L81.1759259,33.4444444 L81.1759259,26.962963 C81.1759259,25.1111111 80.5,23.6481481 78.5833333,23.6481481 C76.9606762,23.7132936 75.686517,25.0614362 75.712963,26.6851852 L75.712963,33.4351852 L73.6759259,33.4351852 L73.6296296,25.2592593 Z"
            id="Shape"
            fill="#1E7FC3"
          ></path>
          <path
            d="M94.1481481,26.787037 C94.151066,26.4973667 94.1199894,26.2083542 94.0555556,25.9259259 C93.7578674,24.5390714 92.5295453,23.5502334 91.1111111,23.5555556 C89,23.5555556 87.75,25.4074074 87.75,27.8888889 C87.75,30.1574074 88.8611111,32.037037 91.0648148,32.037037 C92.5018915,32.0322793 93.7439065,31.0325148 94.0555556,29.6296296 C94.1262239,29.3262727 94.1573464,29.0150473 94.1481481,28.7037037 L94.1481481,26.787037 Z M96.1851852,16.9814815 L96.1851852,30.5555556 C96.1851852,31.5462963 96.1851852,32.6851852 96.2777778,33.4537037 L94.4259259,33.4537037 L94.3333333,31.5092593 L94.287037,31.5092593 C93.5413437,32.9172747 92.0550904,33.7737597 90.462963,33.712963 C87.75,33.712963 85.6666667,31.4166667 85.6666667,28.0092593 C85.6666667,24.3055556 87.962963,21.9814815 90.7037037,21.9814815 C92.0603004,21.8960755 93.3569027,22.5514619 94.0925926,23.6944444 L94.0925926,23.6944444 L94.0925926,16.9814815 L96.1851852,16.9814815 Z"
            id="Shape"
            fill="#1E7FC3"
          ></path>
          <path
            d="M100.314815,22.2222222 L102.777778,28.8518519 C103.037037,29.5925926 103.314815,30.4722222 103.5,31.1481481 L103.546296,31.1481481 C103.759259,30.4722222 103.990741,29.6203704 104.268519,28.8055556 L106.481481,22.2222222 L108.638889,22.2222222 L105.555556,30.2222222 C104.092593,34.0740741 103.101852,36.0462963 101.703704,37.25 C100.99598,37.901095 100.131365,38.3573307 99.1944444,38.5740741 L98.6851852,36.8611111 C99.3394911,36.6454853 99.946198,36.3059809 100.472222,35.8611111 C101.211833,35.2484172 101.798355,34.4716714 102.185185,33.5925926 C102.269504,33.440235 102.325945,33.2740475 102.351852,33.1018519 C102.332781,32.9168816 102.28596,32.7358387 102.212963,32.5648148 L98.0925926,22.2222222 L100.314815,22.2222222 Z"
            id="Shape"
            fill="#1E7FC3"
          ></path>
          <path
            d="M0.694444444,0.694444444 C0.694444444,0.694444444 5.75925926,18.5185185 45.537037,25.25 C45.537037,25.25 35.5185185,29.4259259 34.4259259,48.9722222 C34.4259259,49.0833333 34.4259259,49.1944444 34.4259259,49.3055556 C34.4259259,49.4166667 33.3333333,34.7962963 37.962963,27.6666667 C37.962963,27.6666667 -1.37962963,34.7592593 0.666666667,0.694444444"
            id="Shape"
            fill="#1E7FC3"
          ></path>
          <path
            d="M5.55555556,23.4907407 C5.55555556,23.4907407 16.1111111,34.6574074 35.1851852,30.5555556 C35.1851852,30.5555556 34.6481481,36.3981481 23.9722222,37.2592593 C23.9722222,37.2592593 9.63888889,38.4259259 5.53703704,23.462963"
            id="Shape"
            fill="#F57E20"
          ></path>
          <path
            d="M15.8981481,38.1296296 C15.8981481,38.1296296 25.4907407,41.6666667 32.9259259,36.0185185 C32.9259259,36.0185185 34.1111111,38.1018519 30.4444444,41.787037 C30.4444444,41.787037 23.5462963,47.5 15.8888889,38.0833333"
            id="Shape"
            fill="#F57E20"
          ></path>
        </g>
      </g>
    </svg>
    <h1>SENDY PARTNER VERIFICATION PORTAL</h1>
    <el-form :model="login_form" ref="login_form" @submit="login" :rules="rules">
      <el-form-item label="Email" prop="email">
        <el-input
          placeholder="e.g. sendyer@sendy.co.ke"
          v-model="login_form.email"
          type="email"
          ref="emailInputField"
        ></el-input>
      </el-form-item>
      <el-form-item label="Password" prop="password">
        <el-input
          placeholder="Your Password"
          v-model="login_form.password"
          type="password"
          ref="passwordInputField"
        ></el-input>
      </el-form-item>
      <el-button
        type="primary"
        class="mt"
        @click="login"
        v-loading.fullscreen.lock="logging_in"
      >Login</el-button>
    </el-form>
  </div>
</template>

<script>
export default {
  name: 'login',
  data() {
    return {
      logging_in: false,
      login_form: {
        email: '',
        password: '',
      },
      rules: {
        email: [
          {
            type: 'string',
            required: true,
            message: 'Please input a correct email e.g. sendyer@sendy.co.ke',
            pattern: /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,
            trigger: 'blur',
          },
        ],
        password: [
          {
            required: true,
            message: 'Please input your password',
          },
        ],
      },
    };
  },
  methods: {
    login() {
      const vm = this;

      this.$refs.login_form.validate(valid => {
        if (valid) {
          this.sumbitLoginData();
        } else {
          console.log('invalid');
          return;
        }
      });
    },
    sumbitLoginData() {
      const vm = this;
      console.log('valid!');
      vm.logging_in = true;
      axios
        .post(`${AUTH_URL}verify/login`, {
          email: vm.login_form.email,
          password: vm.login_form.password,
        })
        .then(response => {
          const refreshToken = response.data.refresh_token;
          const accessToken  = response.data.access_token;
          const baseString = accessToken.split('.')[1];
          const decodedString = atob(baseString);
          const parsedDecodedString = JSON.parse(decodedString);
          localStorage.setItem('authenticated', JSON.stringify(true));
          localStorage.setItem('user', JSON.stringify(parsedDecodedString.payload));
          localStorage.setItem('token', accessToken);
          localStorage.setItem('refresh_token', refreshToken);
          this.$router.push({ name: 'applications' });
          // if (response.data.status) {
          //   localStorage.setItem('authenticated', JSON.stringify(true));
          //   localStorage.setItem('user', JSON.stringify(response.data.data));
          //   this.$router.push({ name: 'applications' });
          // } else {
          //   this.$notify.error({
          //     title: 'Error logging in',
          //     message: 'Invalid credentials',
          //   });
          // }
          vm.logging_in = false;
        })
        .catch(error => {
          vm.logging_in = false;
          this.$notify.error({
            title: 'Error logging in',
            message: 'Invalid credentials',
          });
          throw new Error('Could not log in user');
        });
    },
  },
};
</script>
